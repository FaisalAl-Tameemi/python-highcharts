<!-- External plugins -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.17/require.min.js"></script>
<script src="http://code.jquery.com/jquery-2.1.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.1/js/standalone/selectize.js"></script>

<script type="text/javascript">
    requirejs.config({
        paths: {
            'highstock': "http://code.highcharts.com/stock/highstock",
            'standalone': "http://code.highcharts.com/adapters/standalone-framework",
            'export': "http://code.highcharts.com/stock/modules/exporting",

            'underscore': "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min"
        },

        shim: {
            'highstock': {
                deps: ['standalone'],
                exports: 'Highcharts'
            },
            'export': {
                deps: ['highstock']
            },
            'underscore': {
                exports: '_'
            }
        }
    });
</script>

<!-- Stylesheets -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.1/css/selectize.default.min.css"/>


<style>
    .md-chips .md-chip-input-container input:focus {
        outline: none;
        border: none;
        box-shadow: none;
    }

    md-input-container .md-input:focus {
        box-shadow: none;
    }

    .jsoneditor td.tree, .jsoneditor td, .jsoneditor tr, .jsoneditor table {
        border: none;
        margin: 0;
    }
</style>


<script type="text/javascript">
    //inject:js
    require([
        'highstock',
        'underscore',
        'export'
    ], function (select) {

        //Count the number of charts on the page
        if (window.counter == undefined) {
            window.counter = 0;
        } else {
            window.counter++;
        }

        //Create different containers for the charts
        var chartContainer = document.getElementById("container");
        chartContainer.id = "chart" + window.counter.toString();

        var input = $("#variable-selector");
        input.id = "variable-selector" + window.counter.toString();

        var series = [{"data": [1, 2, 5, 9, 6, 3, 4, 8], "name": "List data", "display": true}];
        var options = {"chart": {"type": "line"}};
        var useHighStock = false;

        //Choose a chart type
        var ChartType = useHighStock ? Highcharts.StockChart : Highcharts.Chart;

        var keys = [];
        $.each(series, function (index, serie) {
            keys.push({
                name: serie.name,
                selected: serie.display
            })
        });

        //Set initial chart options
        var chartOptions;
        if (typeof options.chart === "undefined") {
            chartOptions = {renderTo: chartContainer.id};
        } else {
            chartOptions = $.extend(options["chart"], {renderTo: chartContainer.id});
        }

        //Initial rendered series
        var renderedSeries = [];
        options = $.extend(options, {chart: chartOptions}, {series: renderedSeries});
        var chart = new ChartType(options);

        //Default highchart colors
        var colors = {};
        colors.available = ['#7cb5ec', '#434348', '#90ed7d', '#f7a35c', '#8085e9',
            '#f15c80', '#e4d354', '#2b908f', '#f45b5b', '#91e8e1'];
        colors.used = [];


        input.selectize({
            plugins: ['remove_button'],
            delimiter: ',',
            persist: false
        });

        //Show first series
        $scope.selected.keys = _.filter(series,function (obj) {
            return obj.display == true || obj.display === true
        }).map(function (serie) {
            return {
                name: serie.name,
                selected: true
            }
        });

        updateSeries($scope.selected.keys, []);

        function setOptions(options) {
            newChart($.extend(chart.options, options), renderedSeries);
        }

        // Update the series
        function updateSeries(newValue, oldValue) {
            newValue = newValue.map(function (element) {
                return element.name
            });

            oldValue = oldValue.map(function (element) {
                return element.name
            });

            if (newValue.length > oldValue.length) {
                var newKeys = _.difference(newValue, oldValue);
                $.each(newKeys, function (i, newKey) {
                    var index = findSeries(series, newKey);
                    var newSeries = series[index];
                    addSeries(newSeries);
                });
                newChart(chart.options, renderedSeries);

            } else if (newValue.length < oldValue.length) {
                var removedKeys = _.difference(oldValue, newValue);
                $.each(removedKeys, function (i, removedKey) {
                    deleteSeries(removedKey);
                });

                newChart(chart.options, renderedSeries)
            }
        }

        function findSeries(series, key) {
            var index = {};

            var arrayLength = series.length;
            for (var i = 0; i < arrayLength; i++) {
                if (series[i].name == key) {
                    index = i
                }
            }
            return index
        }

        function newChart(options, series) {
            //Disable animation
            var newOptions = $.extend(options, {series: series});
            newOptions.plotOptions['series'] = {animation: false};

            //Get zoom
            var xExtremes = chart.xAxis[0].getExtremes();

            //Re-plot the chart
            chart.destroy();
            chart = new ChartType(newOptions);

            //Reset the zoom
            chart.xAxis[0].setExtremes(xExtremes.min, xExtremes.max, false, false);

            //Re-draw chart
            chart.redraw();
        }

        function addSeries(newSeries) {
            renderedSeries.push($.extend(newSeries, {color: colors.available[0]}));
            colors.used.push(colors.available.splice(0, 1)[0]);
        }

        function deleteSeries(name) {
            var index = findSeries(renderedSeries, name);
            var deletedColor = renderedSeries.splice(index, 1).color;
            var colorIndex = colors.used.indexOf(deletedColor);
            colors.available.push(colors.used.splice(colorIndex, 1)[0]);
        }
    })

</script>


<input type="text" id="variable-selector">
<div id="container" style="height: 400px; min-width: 310px"></div>
