<!-- External plugins -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.17/require.min.js"></script>

<script type="text/javascript">
    requirejs.config({
        paths: {
            'highstock': "http://code.highcharts.com/stock/highstock",
            'standalone': "http://code.highcharts.com/adapters/standalone-framework",
            'export': "http://code.highcharts.com/stock/modules/exporting",

            'angular': "https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.15/angular.min",
            'underscore': "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min",
            'animate': "https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.15/angular-animate.min",
            'aria': "https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.15/angular-aria.min",
            'material': "https://cdnjs.cloudflare.com/ajax/libs/angular-material/0.9.4/angular-material.min"
        },

        shim: {
            'highstock': {
                deps: ['standalone'],
                exports: 'Highcharts'
            },
            'export': {
                deps: ['highstock']
            },
            'angular': {
                exports: 'angular'
            },
            'underscore': {
                exports: '_'
            },
            'animate': {
                deps: ['angular']
            },
            'aria': {
                deps: ['angular']
            },
            'material': {
                deps: ['angular', 'animate', 'aria']
            }
        }
    });
</script>

<!-- Stylesheets -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/angular-material/0.9.4/angular-material.min.css"/>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">


<style>
    .md-chips .md-chip-input-container input:focus {
        outline: none;
        border: none;
        box-shadow: none;
    }
</style>

<script type="text/javascript">
    //inject:js
    require(['highstock', 'angular', 'underscore', 'animate', 'aria', 'material', 'export'], function () {

        //Count the number of apps / charts on the page
        if (window.counter == undefined) {
            window.counter = 0;
        } else {
            window.counter++;
        }

        //Create different containers for the apps and charts
        var chartContainer = document.getElementById("container");
        chartContainer.id = "chart" + window.counter.toString();

        var appContainer = document.getElementById("appid");
        appContainer.id = "app" + window.counter.toString();


        /*
         * Angular app
         * */
        var app = angular.module('myApp', [
            "ngMaterial"
        ]);

        app.controller('MyController', ['$scope', function ($scope) {

            //TODO: Bring outside of this module
            var series = #series;
            var options = #options;

            var keys = [];
            angular.forEach(series, function(serie) {
                keys.push(serie.name)
            });

            $scope.keys = keys;

            $scope.readonly = false;
            $scope.selectedItem = null;
            $scope.searchText = null;
            $scope.querySearch = querySearch;
            $scope.keys = keys;
            $scope.selected = {};
            $scope.selected.keys = [];
            /**
             * Search for vegetables.
             */
            function querySearch (query) {
                var availableKeys = _.difference($scope.keys, $scope.selected.keys);
                return query ? availableKeys.filter(createFilterFor(query)) : [];
            }
            /**
             * Create filter function for a query string
             */
            function createFilterFor(query) {
                var lowercaseQuery = angular.lowercase(query);
                return function filterFn(key) {
                    return (angular.lowercase(key).indexOf(lowercaseQuery) > -1);
                };
            }

            var chartOptions = angular.extend(
                    options["chart"],
                    {renderTo: chartContainer.id}
            );
            options = angular.extend(options, {chart: chartOptions}, {series: []});

            var chart = new Highcharts.StockChart(options);

            /**
             * Watches to update the chart
             */

            // Update the series
            $scope.$watch('selected.keys', function(newValue, oldValue) {
                var index = {};

                if (newValue.length > oldValue.length) {
                    var newKey = _.difference(newValue, oldValue)[0];
                    index = findSeries(series, newKey);

                    chart.addSeries(series[index])

                } else if (newValue.length < oldValue.length && newValue.length > 0) {
                    var removedKey = _.difference(oldValue, newValue)[0];
                    index = findSeries(chart.series, removedKey);

                    chart.series[index].remove();
                }
            }, true);

            // Update the options
            $scope.$watch('options', function(newValue, oldValue) {
                chart = new Highcharts.Chart(newValue);
            });


            function findSeries(series, key) {
                var index = {};

                var arrayLength = series.length;
                for (var i = 0; i < arrayLength; i++) {
                    if (series[i].name == key) {
                        index = i
                    }
                }
                return index
            }

        }]);

        angular.bootstrap(appContainer, ['myApp']);
    });
</script>


<div id="appid">

    <div ng-controller="MyController">
        <md-content class="md-padding autocomplete" layout="row">
            <div flex="90"><md-chips ng-model="selected.keys" md-autocomplete-snap md-require-match>
                <md-autocomplete
                        md-selected-item="selectedItem"
                        md-search-text="searchText"
                        md-items="item in querySearch(searchText)"
                        md-item-text="item"
                        md-autoselect="true"
                        md-min-length="1"
                        placeholder="Add a variable">
                    <span md-highlight-text="searchText">{{item}}</span>
                </md-autocomplete>
                <md-chip-template>
                    <span>
                      <strong>{{$chip}}</strong>
                    </span>
                </md-chip-template>
            </md-chips></div>
            <div flex="10" layout="row" layout-align="center center">
                <i class="fa fa-cog fa-2x"></i>
            </div>
        </md-content>



        <div id="container" style="height: #height; min-width: 310px"></div>
    </div>
</div>